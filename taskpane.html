<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Excel Summary Add-In</title>

  <!-- Load Office.js -->
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

  <script>
    Office.onReady(() => {
      window.generateSummary = async function () {
        try {
          console.log("[Phase 1] Starting summary generation...");

          await Excel.run(async (context) => {
            console.log("[Phase 2] Accessing active worksheet and data...");

            const sheet = context.workbook.worksheets.getActiveWorksheet();
            const range = sheet.getUsedRange();
            range.load("values");
            await context.sync();

            const tableText = range.values.map(row => row.join("\t")).join("\n");
            const prompt = "Summarize the following table using the same wording and structure as the training summary. Do not omit any section or sub-table.\n\n" + tableText;

            const encodedKey = "MmJ3dEJTN0s3cHpGMnlXQnlqZ2tXaTNFVDBJaFVyVk9IYkZubDVUYXdiSWNmaUttMGc3dkpRUUo5OUJEQUNIcnpwcVhKM3czQUFBQkFDT0dEUUtZ";
            const apiKey = atob(encodedKey);  
            const endpoint = "https://excelsummary.openai.azure.com/openai/deployments/gpt-4-0613-ft-1afdc7410eda42a1aac5db4ffd4e73c0/chat/completions?api-version=2025-01-01-preview";  

            console.log("[Phase 3] Sending request to Azure OpenAI...");

            const response = await fetch(endpoint, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "api-key": apiKey
              },
              body: JSON.stringify({
                messages: [
                  {
                    role: "system",
                    content: "You are a reporting assistant. Match the format and wording of the training summaries exactly. Detect from the table whether figures are in thousands or millions, and apply the correct representation: use 'M' for thousands and 'MM' for millions. Scale the numbers accordingly before generating the summary. Only change values, not summary structure."
                  },
                  { role: "user", content: prompt }
                ],
                temperature: 0.3,
                max_tokens: 500
              })
            });

            const result = await response.json();
            const summary = result.choices[0].message.content;
            console.log("[Phase 4] Received response. Preview:", summary);

            const encodedSummary = encodeURIComponent(encodeURIComponent(summary)); // DOUBLE encoding for safety

            Office.context.ui.displayDialogAsync(
              `https://dhruvil-trivedi.github.io/excel-taskpane-summarizer/dialog.html?text=${encodedSummary}`,
              { height: 40, width: 40 }
            );
            console.log("[Phase 5] Dialog launched");
          });
        } catch (error) {
          console.error("[ERROR] generateSummary failed:", error.message);
          const fallback = encodeURIComponent(encodeURIComponent("ERROR: " + error.message));
          Office.context.ui.displayDialogAsync(
            `https://dhruvil-trivedi.github.io/excel-taskpane-summarizer/dialog.html?text=${fallback}`,
            { height: 30, width: 30 }
          );
        }
      };
    });
  </script>
</head>
<body>
  <h2>Generate Table Summary</h2>
  <button onclick="generateSummary()">Generate Summary</button>
</body>
</html>
